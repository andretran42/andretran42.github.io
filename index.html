<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <script src="//mozilla.github.io/pdf.js/build/pdf.js"></script>
  </head>
  <body>
    <div class="header1">
      <h1 class="header_text">Convert PDF to CSV</h1>
    </div>
    <div class="upload">
      <label class="upload_div_item" for="PDF"
        ><span>Upload play-by-play PDF: </span></label
      ><br />
      <label>Paste PDF Link</label>
      <input
        id="input_link"
        class="upload_div_item"
        type="url"
        name="PDF"
        pattern="https://.*"
        placeholder="https://example.com"
      />
      <label>Enter <strong>OFFENSE</strong> team name</label>
      <input
        type="text"
        id="OFF_TEAM_NAME"
        class="upload_div_item"
        placeholder="William & Mary"
      />
      <label>Enter <strong>OFFENSE</strong> team abbreviation</label>
      <input
        type="text"
        id="OFF_TEAM_ABBR"
        class="upload_div_item"
        placeholder="W&M"
      />
      <label>Enter <strong>DEFENSE</strong> team name</label>
      <input
        type="text"
        id="DEF_TEAM_NAME"
        class="upload_div_item"
        placeholder="Delaware"
      />
      <label>Enter <strong>DEFENSE</strong> team abbreviation</label>
      <input
        type="text"
        id="DEF_TEAM_ABBR"
        class="upload_div_item"
        placeholder="DEL"
      />
      <button id="submit-btn" class="upload_div_item">Submit</button>
    </div>

    <script>
      submit = document.querySelector("#submit-btn");
      var pdfjsLib = window["pdfjs-dist/build/pdf"];
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "//mozilla.github.io/pdf.js/build/pdf.worker.js";
      const fileInput = document.getElementById("input");
      var selectedFile;
      var typedarray;

      function substr_index(arr, substring) {
        my_arr = [];
        for (const [index, element] of arr.entries()) {
          if (element.str.includes(substring)) {
            my_arr.push(index);
          }
        }
        if (my_arr.length > 0) {
          return my_arr;
        } else if (my_arr.length == 0) {
          return [999];
        }
      }

      submit.addEventListener("click", () => {
        selectedFile = document.getElementById("input_link").value;
        const OFF_TEAM_NAME = document.getElementById("OFF_TEAM_NAME").value;
        const OFF_TEAM_ABBR = document.getElementById("OFF_TEAM_ABBR").value;
        const DEF_TEAM_NAME = document.getElementById("DEF_TEAM_NAME").value;
        const DEF_TEAM_ABBR = document.getElementById("DEF_TEAM_ABBR").value;
        const pdf = pdfjsLib.getDocument(selectedFile);
        var text_array = [];
        function extractText(file) {
          return file.promise.then(function (pdf) {
            var maxPage = pdf.numPages;
            var countPromises = [];
            for (var curPage = 1; curPage <= maxPage; curPage++) {
              var page = pdf.getPage(curPage);
              countPromises.push(
                page.then(function (page) {
                  var textContent = page.getTextContent();
                  return textContent.then(function (text) {
                    return text.items;
                  });
                })
              );
            }

            return Promise.all(countPromises).then(function (texts) {
              return texts;
            });
          });
        }
        extractText(pdf).then(
          function (text) {
            text = text.flat();

            let play_by_play = text.slice(
              substr_index(text, "Play By Play")[0]
            );
            let len_play = play_by_play.length;
            let q = "1";
            const row_arr = [
              [
                "Quarter",
                "Series",
                "Play",
                "Down",
                "Distance",
                "Ydline",
                "Gain",
              ],
            ];
            play_by_play.forEach((element, index) => {
              play_by_play[index] = play_by_play[index].str;
            });
            play_by_play.forEach((element, index) => {
              if (element.includes(OFF_TEAM_NAME + " at")) {
                play_by_play[index] = "DELIMIT " + OFF_TEAM_ABBR;
              } else if (element.includes(DEF_TEAM_NAME + " at")) {
                play_by_play[index] = "DELIMIT " + DEF_TEAM_ABBR;
              } else if (element.includes("punt")) {
                play_by_play[index] = "PUNT";
              } else if (element.includes("attempt")) {
                play_by_play[index] = "ATTEMPT";
              } else if (element.includes("kickoff")) {
                play_by_play[index] = "KICKOFF";
              } else if (element.includes("incomplete")) {
                play_by_play[index] = play_by_play[index].replace(
                  "incomplete",
                  "0 yards"
                );
              } else if (element.includes("Start of Quarter #2")) {
                play_by_play[index] = "DELIMIT 2";
              } else if (element.includes("Start of Quarter #4")) {
                play_by_play[index] = "DELIMIT 4";
              } else if (
                element.includes("Start of Quarter #3") ||
                element.includes("End of")
              ) {
                play_by_play[index] = "DELIMIT 3";
              }
            });
            console.log(play_by_play);
          },
          function (reason) {
            console.error(reason);
          }
        );
      });
    </script>
  </body>
</html>
